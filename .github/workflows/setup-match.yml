name: Setup Match (One-Time iOS Certificates) - API Key Only

# ---------------------------------------------------------------------------
#  ‚ö†Ô∏è  Ce workflow s'ex√©cute UNE SEULE FOIS pour initialiser fastlane match
#      - Utilise UNIQUEMENT une App Store Connect API Key (pas d'Apple ID / 2FA)
#      - Cr√©e les certificats iOS + provisioning profiles
#      - Stocke tout dans votre repo Git (MATCH_GIT_URL)
# ---------------------------------------------------------------------------

on:
  workflow_dispatch:
    inputs:
      team_id:
        description: "Your Apple Team ID"
        required: true
        type: string

jobs:
  setup-match:
    name: üîê Initialize Match & Create iOS Certificates (API Key)
    runs-on: macos-15  # macOS 15 has Xcode 16.x

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ------------------------------
      #  Node & d√©pendances JS
      # ------------------------------
      - name: üì¶ Install dependencies
        run: npm ci

      - name: üóëÔ∏è Remove expo-dev-client (not needed for production builds)
        run: npm uninstall expo-dev-client

      # ------------------------------
      #  iOS native project (Expo)
      # ------------------------------
      - name: üîß Select Xcode 16.1
        run: sudo xcode-select -s /Applications/Xcode_16.1.app/Contents/Developer

      - name: üî® Generate iOS native folder
        run: npx expo prebuild --platform ios --clean

      - name: üîß Fix iOS nullability issues
        run: |
          chmod +x scripts/fix-ios-nullability.sh
          bash scripts/fix-ios-nullability.sh

      # ------------------------------
      #  Ruby & fastlane
      # ------------------------------
      - name: üíé Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      # ------------------------------
      #  App Store Connect API Key
      #  - D√©code la cl√© .p8 depuis le secret BASE64
      #  - G√©n√®re ios/fastlane/keys/api_key.json au format attendu par fastlane
      # ------------------------------
      - name: üîê Create App Store Connect API Key files (p8 + api_key.json)
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_KEY_BASE64 }}
        run: |
          mkdir -p ios/fastlane/keys

          # 1) √âcrire le fichier .p8 √† partir du secret base64
          echo "$APP_STORE_CONNECT_KEY_BASE64" | base64 -d > "ios/fastlane/keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"
          chmod 600 "ios/fastlane/keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8"

          # 2) √âchapper le contenu pour JSON (remplace les sauts de ligne par \n)
          KEY_ESCAPED=$(python3 - << 'PY'
            import json
            import os
            from pathlib import Path

            key_id = os.environ["APP_STORE_CONNECT_KEY_ID"]
            path = Path(f"ios/fastlane/keys/AuthKey_{key_id}.p8")
            text = path.read_text()

            # json.dumps renvoie une cha√Æne avec des guillemets autour, on les retire
            print(json.dumps(text)[1:-1])

          

          # 3) Cr√©er api_key.json pour fastlane (champs attendus : key_id, issuer_id, key)
          cat > ios/fastlane/keys/api_key.json << EOF
          {
            "key_id": "${APP_STORE_CONNECT_KEY_ID}",
            "issuer_id": "${APP_STORE_CONNECT_ISSUER_ID}",
            "key": "$KEY_ESCAPED"
          }
          EOF

          echo "‚úÖ API Key files created"

      # ------------------------------
      #  Matchfile (configuration de fastlane match)
      # ------------------------------
      - name: üìù Create Matchfile (no Apple ID required)
        run: |
          cat << EOF > ios/fastlane/Matchfile
          git_url("${{ secrets.MATCH_GIT_URL }}")
          storage_mode("git")
          type("appstore")
          app_identifier(["com.maya.app"])
          team_id("${{ github.event.inputs.team_id }}")
          api_key_path("fastlane/keys/api_key.json")
          EOF
          echo "‚úÖ Matchfile created"

      # ------------------------------
      #  Initialisation de match (cr√©ation certs + profiles)
      # ------------------------------
      - name: üé´ Initialize Match and Create Certificates (API Key)
        working-directory: ios
        run: |
          echo "üîê Initializing Match with App Store Connect API Key..."

          bundle exec fastlane match appstore \
            --verbose \
            --force

          echo "‚úÖ Match initialized successfully!"
          echo "‚úÖ Certificates and profiles stored in: ${{ secrets.MATCH_GIT_URL }}"
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

      # ------------------------------
      #  R√©sum√©
      # ------------------------------
      - name: ‚úÖ Success - Match is ready!
        run: |
          echo "======================================"
          echo "üéâ MATCH SETUP COMPLETED!"
          echo "======================================"
          echo ""
          echo "‚úÖ iOS Certificates created"
          echo "‚úÖ Provisioning Profiles created"
          echo "‚úÖ Everything stored in: ${{ secrets.MATCH_GIT_URL }}"
          echo ""
          echo "üìã Next steps:"
          echo "1. The deploy workflow can now build iOS"
          echo "2. You can disable or delete this workflow"
          echo ""
          echo "======================================"
